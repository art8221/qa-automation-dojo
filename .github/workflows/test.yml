name: Java Tests

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java-version: ['21']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java ${{ matrix.java-version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java-version }}
          distribution: 'temurin'

      - name: Setup UTF-8 encoding
        run: |
          echo "JAVA_TOOL_OPTIONS=-Dfile.encoding=UTF-8" >> $GITHUB_ENV
          echo "GRADLE_OPTS=-Dfile.encoding=UTF-8" >> $GITHUB_ENV

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Cache Gradle dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle

      - name: Verify JUnit configuration
        run: |
          echo "=== Checking JUnit parallel execution configuration ==="
          if [ -f "src/test/resources/junit-platform.properties" ]; then
            echo "📋 Found junit-platform.properties:"
            cat src/test/resources/junit-platform.properties
          else
            echo "⚠️  No junit-platform.properties found - using default settings"
          fi
          echo ""

      - name: Run Tests with Parallel Execution
        run: |
          echo "=== Running tests with parallel execution ==="
          
          # Run tests with parallel execution (default)
          echo "1. Running with parallel execution:"
          time ./gradlew :public-apis:jsonplaceholder:test \
            --tests "*JsonPlaceholderCRUDTests" \
            --info \
            --rerun-tasks 2>&1 | \
            grep -E "(PASSED|FAILED|Tests run:|Test class:|Thread|worker|BUILD|SUCCESSFUL|FAILED)" | \
            tail -20
          
          echo ""
          echo "2. Running with sequential execution for comparison:"
          time ./gradlew :public-apis:jsonplaceholder:test \
            --tests "*JsonPlaceholderCRUDTests" \
            -Djunit.jupiter.execution.parallel.enabled=false \
            --info 2>&1 | \
            grep -E "(PASSED|FAILED|Tests run:|Test class:|BUILD|SUCCESSFUL)" | \
            tail -10

      - name: Run Parallel Check Test
        if: always()
        run: |
          echo "=== Running parallel check test ==="
          
          # Create test directory if it doesn't exist
          mkdir -p src/test/kotlin/com/dojo/jsonplaceholder/tests
          
          # Create the parallel test
          cat > src/test/kotlin/com/dojo/jsonplaceholder/tests/ParallelCheckTest.kt << 'EOF'
          package com.dojo.jsonplaceholder.tests
          
          import org.junit.jupiter.api.Test
          import org.junit.jupiter.api.parallel.Execution
          import org.junit.jupiter.api.parallel.ExecutionMode
          
          @Execution(ExecutionMode.CONCURRENT)
          class ParallelCheckTest {
          
              @Test
              fun test1() {
                  val thread = Thread.currentThread().name
                  println("[\$thread] Test 1 started")
                  Thread.sleep(1000)
                  println("[\$thread] Test 1 finished")
              }
          
              @Test
              fun test2() {
                  val thread = Thread.currentThread().name
                  println("[\$thread] Test 2 started")
                  Thread.sleep(1000)
                  println("[\$thread] Test 2 finished")
              }
          
              @Test
              fun test3() {
                  val thread = Thread.currentThread().name
                  println("[\$thread] Test 3 started")
                  Thread.sleep(1000)
                  println("[\$thread] Test 3 finished")
              }
          
              @Test
              fun test4() {
                  val thread = Thread.currentThread().name
                  println("[\$thread] Test 4 started")
                  Thread.sleep(1000)
                  println("[\$thread] Test 4 finished")
              }
          }
          EOF
          
          echo "Running parallel check test..."
          time ./gradlew :public-apis:jsonplaceholder:test \
            --tests "*ParallelCheckTest" \
            --info 2>&1 | \
            grep -B1 -A1 -E "(Thread|Test.*started|Test.*finished|BUILD|PASSED|FAILED)" || \
            echo "No output matched the filter"
          
          echo ""
          echo "Parallel check completed"

      - name: Run All Module Tests
        if: always()
        run: |
          echo "=== Running all tests in jsonplaceholder module ==="
          ./gradlew :public-apis:jsonplaceholder:test \
            --no-daemon \
            --info 2>&1 | \
            grep -E "(Test class:|Tests run:|FAILED|SUCCESSFUL|BUILD)" || \
            echo "No test output captured"

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-java${{ matrix.java-version }}
          path: |
            **/build/reports/tests/
            **/build/test-results/
          retention-days: 7

      - name: Upload Build Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-java${{ matrix.java-version }}
          path: |
            **/build/**/*.log
            **/*.log
          retention-days: 7

      - name: Generate Test Summary
        if: always()
        run: |
          echo "📋 === TEST EXECUTION SUMMARY ==="
          echo ""
          
          # Check for test reports
          if find . -name "TEST-*.xml" -type f | grep -q "."; then
            echo "✅ Test XML reports found"
          
            # Count tests
            TOTAL_TESTS=$(find . -name "TEST-*.xml" -type f -exec grep -h "testsuite" {} \; | \
              grep -o 'tests="[0-9]*"' | sed 's/[^0-9]//g' | paste -sd+ | bc)
            TOTAL_FAILURES=$(find . -name "TEST-*.xml" -type f -exec grep -h "testsuite" {} \; | \
              grep -o 'failures="[0-9]*"' | sed 's/[^0-9]//g' | paste -sd+ | bc)
            TOTAL_ERRORS=$(find . -name "TEST-*.xml" -type f -exec grep -h "testsuite" {} \; | \
              grep -o 'errors="[0-9]*"' | sed 's/[^0-9]//g' | paste -sd+ | bc)
          
            echo "📊 Statistics:"
            echo "   Total tests: ${TOTAL_TESTS:-0}"
            echo "   Failures: ${TOTAL_FAILURES:-0}"
            echo "   Errors: ${TOTAL_ERRORS:-0}"
          
            if [ "${TOTAL_FAILURES:-0}" -gt 0 ] || [ "${TOTAL_ERRORS:-0}" -gt 0 ]; then
              echo "❌ Some tests failed or errored"
            else
              echo "✅ All tests passed!"
            fi
          else
            echo "⚠️  No test reports found"
          fi
          
          echo ""
          echo "🔍 Parallel execution check:"
          if find . -name "*.log" -type f -exec grep -l "worker-\|Thread-\|ForkJoinPool" {} \; 2>/dev/null | grep -q "."; then
            echo "✅ Parallel execution detected in logs"
          else
            echo "ℹ️  No parallel execution indicators found in logs"
          fi
          
          echo ""
          echo "📁 Available artifacts:"
          echo "   - test-results-java${{ matrix.java-version }} (test reports)"
          echo "   - build-logs-java${{ matrix.java-version }} (build logs)"